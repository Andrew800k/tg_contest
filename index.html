<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка доступа</title>
    <script type="module" src="config.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #captcha-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #animation-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60vh;
            width: 100%;
        }

        #animation-container {
            width: 55vw;
            max-width: 400px;
            min-width: 220px;
            display: none;
        }

        .result-container {
            height: 20vh;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            max-width: 500px;
        }

        #status {
            font-size: clamp(18px, 4vw, 28px);
            color: black;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            width: 100%;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <div id="captcha-container">
        <div class="cf-turnstile" id="captcha" data-callback="unlockSite"></div>
    </div>

    <div id="animation-wrapper">
        <div id="animation-container"></div>
    </div>

    <div class="result-container">
        <div id="status"></div>
    </div>

    <script type="module">
        import CONFIG from './config.js';

        let cfToken = "";
        let telegramId = "";

        if (!window.Telegram || !Telegram.WebApp || !Telegram.WebApp.initDataUnsafe) {
            console.log("Приложение открыто в браузере.");
            document.body.innerHTML = "<h1>Тестовый текст</h1>";
        } else {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
            if (initDataUnsafe && initDataUnsafe.user) {
                telegramId = initDataUnsafe.user.id;
            }
        }

        const animationContainer = document.getElementById("animation-container");
        const anim = lottie.loadAnimation({
            container: animationContainer,
            renderer: "svg",
            loop: true,
            autoplay: false,
            path: "cat.json"
        });

        function unlockSite(token) {
            cfToken = token;
            console.log("CAPTCHA Token:", cfToken);
            document.getElementById("captcha-container").remove();
            animationContainer.style.display = "block";
            anim.play();
            checkAccess();
        }

        async function checkAccess() {
            if (!cfToken || !telegramId) {
                document.getElementById("status").innerText = "Ошибка: Telegram ID не получен!";
                document.getElementById("status").style.opacity = "1";
                return;
            }

            try {
                const response = await fetch("https://nameless-star-cc22.smkov.workers.dev", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cfToken, telegramId })
                });

                if (!response.ok) {
                    throw new Error(`Ошибка! Статус: ${response.status}`);
                }

                const data = await response.json();
                const statusElement = document.getElementById("status");

                if (data.status === "allowed") {
                    statusElement.innerHTML = "✅ Условия выполнены";
                    Telegram.WebApp.HapticFeedback.impactOccurred("medium");
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                } else {
                    statusElement.innerHTML = "❌ Условия не выполнены";
                    Telegram.WebApp.HapticFeedback.notificationOccurred("error");
                    confetti({ particleCount: 80, spread: 60, startVelocity: -40, gravity: 1.2, origin: { y: -0.2 }, colors: ['#ff0000', '#ff4444', '#cc0000'] });
                }
                statusElement.style.opacity = "1";
            } catch (error) {
                console.error("Ошибка запроса:", error);
                document.getElementById("status").innerHTML = "❌ Ошибка проверки ID";
                document.getElementById("status").style.opacity = "1";
            }
        }

        window.unlockSite = unlockSite;
    </script>
</body>
</html>
